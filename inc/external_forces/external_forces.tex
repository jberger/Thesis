%This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/3.0/us/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.

\section{Formal Extension to Include Generic External Forces} \label{sec:external_forces}

\subsection{Mathematical Formulation of External Force Contribution}
\ref{eq:potential_integral} is the entry point for the internal Coulombic repulsion force; since both potentials and integrals are linear, one may add additional potentials so that it becomes
\begin{equation}
  \begin{split}
    \Phi(\vec{r};t) \rightarrow & \int d\vecprime{r} \left( V(\vec{r} - \vecprime{r}) + \sum V_{ext}(\vec{r}) \right) n(\vecprime{r}; t) \\
    = & \int d\vecprime{r} V(\vec{r} - \vecprime{r}) n(\vecprime{r}; t) + \sum \int d\vecprime{r} V_{ext}(\vec{r}) n(\vecprime{r}; t) \\
    = & \Phi(\vec{r};t) + \Phi_{ext}(\vec{r};t)
  \end{split}
\end{equation}
This form of $\Phi(\vec{r};t)$ can be substituted into the definition of $K^{force}$ (\ref{eq:Kforce}), again in the basis defined in \ref{eq:coordinate_vector} 
\begin{equation}
  \begin{split}
    K^{force}_{ij} \rightarrow & \frac{1}{N} \int u_i u_j \frac{\partial f}{\partial \vec{p}} \frac{\partial}{\partial \vec{r}} \left( \Phi(\vec{r};t) + \Phi_{ext}(\vec{r};t) \right) d\vec{r} d\vec{p} \\
    \equiv & K^{int}_{ij} + \sum K^{ext}_{ij}
  \end{split}
\end{equation}
where $K^{int}$ is simply the old $K^{force}$. Noting that the spatial derivative of a potential is just the force, we can now define the matrix contributed by each external force is given by
\begin{equation} \label{eq:Kint}
  K^{ext}_{ij} = \frac{1}{N} \iint u_i u_j \left [ \frac{\partial}{\partial \vec{p}} f(\vec{r}, \vec{p}; t) \right ] \cdot \vec{F}_{ext}\;d^{3}x\,d^{3}p
\end{equation}
Finally, the general form of \ref{eq:gaussian_integral_dt_k} for (possibly multiple) external force ($\vec{F}_{ext}$) contributions is now
\begin{equation}
  \frac{\partial}{\partial t} A^{-1}_{ij} = K^{flow}_{ij} + K^{int}_{ij} + \sum K^{ext}_{ij}
\end{equation}

\subsection{Constant External Forces}

For constant static forces having no dependence in $ x $, $ y $, $ z $, or $ t $, one can readily show that there is no effect on the pulse propagation parameters $ \sigma_{ \alpha } $, $ \eta_{ \alpha } $, and $ \gamma_{ \alpha } $.
For example, consider a field consider a field $ \vec{E} = -E \hat{z} $ such that electrons are accelerated in the positive $ z $ direction by $ \vec{F}_{ext} = qE \hat{z} = q ( V / d ) \hat{z} $, so that from \ref{eq:Kint} we have
\begin{equation}
 \begin{split} 
  K^{ext}_{ij} = \frac{1} {N} \dfrac{qV} {d} \int{ u_{i} u_{j} \left( \frac{p_{z}} {\eta_{z}} - \frac{\gamma_{z} z} {\sigma_{z} \eta_{z}} \right) f d^{3}x   d^{3}p } ;
 \end{split}
\end{equation}
but it is clear that no function of this form multiplying $ f $, which is a Gaussian distribution, can avoid creating an odd integrand, and thus $ K_{ij}^{ext} = 0 $ for all $ i $ and $ j $ (or equivalently $ K^{ext} = \hat{0} $) meaning that this static field has no effect on the parameters of the pulse.
Of course, this is only true in the pulse frame, where there is no total momentum and thus $ \Delta E = \left( \Delta p \right)^{2} / 2 m_{e} $ is unchanged.
However, in the lab frame, where  $ \Delta E = p \Delta p / m_{e} $, there is an increase in the momentum spread, as the pulse now has the large momentum $p$ imparted by the accelerating field.

\subsection{Linear External Forces}

%External forces that vary with position in the pulse reference frame (i.e., are not constant) act to change the electron pulse propagation dynamics, most often by affecting $\gamma_{\alpha}$ --- the spatial dependence of the local relative mean electron momenta.
%Below, we consider two examples of electron optical elements that are being used, or are under consideration, for controlling and manipulating the space-time dynamics of electron pulses in DTEM and UED instrumentation; namely, magnetic lenses for spatial focusing and RF pulse compression cavities.

For the case of a perfect lens, or in the longitudinal direction a perfect RF compression element, with a parabolic potential, the external force is linear with distance from the center of the electron pulse: 
\begin{equation} \label{eq:linear_force}
\vec{F}_{ext} = - M_{ \smallT } r \hat{\operatorname{r}} - M_{z} z \hat{\operatorname{z}} \text{ .}
\end{equation}
Here, $M_{ \smallT }$ and $M_{z}$ characterize the strength of a lens or a compressor, respectively, and are chosen to be positive for pulse focusing. Substitution into the integral equation for the $ K^{ext} $ matrix elements,
\begin{equation}
 \begin{split} 
  K^{ext}_{ij} & \equiv \dfrac{1} {N} \int u_{i} u_{j} ( \vec{\nabla}_{p} f ) \cdot \vec{F}_{ext} d^{3} x d^{3} p \\ & = \dfrac{1} {N} \int u_{i} u_{j} \biggl[ x \left( \dfrac{ p_{x} } { \eta_{ \smallT } } - \dfrac{ \gamma_{ \smallT } x } { \sigma_{ \smallT } \eta_{ \smallT } } \right) + y \left( \dfrac{ p_{y} } { \eta_{ \smallT } } - \dfrac{ \gamma_{ \smallT } y } { \sigma_{ \smallT } \eta_{ \smallT } } \right) \\ & \quad + z \left( \dfrac{ p_{z} } { \eta_{z} } - \dfrac{ \gamma_{z} z } { \sigma_{z} \eta_{z} } \right) \biggr] f d^{3} x d^{3} p ,
 \end{split}
\end{equation}
leads to the $6\times6$ matrix
\begin{equation}
K^{ext} = 
\begin{pmatrix}
\hat{k}^{lin}_{\smallT} & \hat{0} & \hat{0} \\
\hat{0} & \hat{k}^{lin}_{\smallT} & \hat{0} \\
\hat{0} & \hat{0} & \hat{k}^{lin}_{z}
\end{pmatrix} \text{ ,}
\end{equation}
where
\begin{equation}
\hat{k}^{lin}_{\alpha} =
\begin{pmatrix}
0 & M_{\alpha} \sigma_{\alpha} \\
M_{\alpha} \sigma_{\alpha} & 2 M_{\alpha} \gamma_{\alpha} \text{.}
\end{pmatrix} \text{ .}
\end{equation}
which by \ref{eq:dainvdt} yields an additional term $M_{\alpha} \sigma_{\alpha}$ which is added to the original $\dfrac{d \gamma_{\alpha}}{d t}$ equation.

\subsection{Validity and Limitations}

The presented extension to the AG model to include external forces acting on the electron pulse is valid only within the limits of the analytical method itself; in particular, its mean internal space-charge field and self-similar Gaussian approximations.\cite{michalik_analytic_2006}
As a result, the extension reflects a first-order (i.e., linear force) analysis of the effects of electron optics upon electron pulse propagation.
Nonetheless, for free-space propagation, the AG model of charge bunch dynamics has already been shown to be very consistent with full Monte Carlo (i.e., particle tracking) simulations for a wide variety of electron pulse shapes,\cite{michalik_analytic_2006,michalik_evolution_2009} including the uniform ellipsoid.\cite{luiten_how_2004}
This successful benchmarking is due primarily to the versatility of the AG model which results from its use of transverse and longitudinal pulse position and momentum variances.
Consequently, the AG approach is applicable to both the single electron per pulse limit,\cite{lobastov_four-dimensional_2005} where momentum variances determine the pulse evolution and the model is exact (obeying Gaussian optics), and the high charge density limit in which space-charge effects dominate.\cite{luiten_how_2004,siwick_ultrafast_2002,cao_femtosecond_2003}
It is this versatility combined with its computational efficiency that makes the presented extended AG model particularly suitable for rapid initial assessments of pulsed electron microscope column designs and electron pulse delivery systems in UED experiments.
Verification of the validity (and determination of the limits) of the extended AG model will, of course, require future comparison with both experiment and more complete simulations of electron pulse propagation dynamics (e.g., full particle tracking models) that include nonlinear forces, for both the intra-pulse space-charge field and the description of aberrations in electron optics.

Further, these analyses are performed in the non-relativistic limit, which is a reasonable approximation for the typical 20-200keV electron energies employed in UED and electron microscopy.
Extension to include relativistic effects is conceptually straightforward using standard transformations between the laboratory and electron pulse reference frames.

\section{Practical Extension to Include Magnetic Lenses and RF Cavities}

\subsection{Region of Influence}

To specify the physical region of influence of the lenses, it is convenient to redefine $M_{i}$ to include a super-Gaussian envelope in $z^{\prime}$, the position of the peak of the pulse in the lab frame;
\begin{equation} \label{eq:reg_of_influence}
  M_{i}	\to M_{i} \exp \left [ - \left (  \frac{ z^{\prime} - z_{lens}^{\prime} }{ L_{lens} / 2 } \right )^{ 2 n } \right ] \text{ ,}
\end{equation}
where $z_{lens}^{\prime}$ is the position of the center of the lens, $L_{lens}$ is the length of the lens and $n$ is the super-Gaussian order parameter.
The order parameter defines the ``sharpness'' of the edge of the region of influence with integer values ranging from 1 (a simple Gaussian) through $\infty$ (a top-hat).
We connect $z^{\prime}$ to $t$ through $ v_{{ \scriptscriptstyle 0}} $; the kinetic equations are simply defined for the position of the peak of the pulse.

\subsection{Magnetic Lenses}

A magnetic lens may be modeled using one linear force contribution.
Unfortunately, it is not practical to write an analytic form of the magnitude of this term; the field distribution is very complicated to describe\cite{montgomery_some_1961} and the ``lensing'' action is actually a compound force (first rotating the beam, then lensing).
We have found that in practice, characterizing a specific magnetic lens ($M_{\smallT}(I)$ where $I$ is the current in the magnetic lens) is much easier than attempting to find a generic functional form.

\subsection{RF Cavities}

In the longitudinal ($ z $) direction, a resonant radio-frequency (RF) cavity can be used in a UEM column or UED experiment \cite{oudheusden_electron_2007,fill_sub-fs_2006} to act as a pulse compression or `temporal focusing' element.
The model of the RF cavity is different from the magnetic lens in two distinct ways.
First, the RF cavity contains several different fields and thus contributes several different linear force terms to the overall equation set.
Second, though there are more terms, their magnitudes are easily connected to the physical characteristics of the cavity.

Although there are many possible resonant cavity structures,\cite{oudheusden_electron_2007,humphries_principles_1986} for simplicity, this analysis will consider only the evacuated cylindrical (or `pillbox') $\text{TM}_{010}$ cavity for which the electrons propagate down the axis.\cite{fill_sub-fs_2006,humphries_principles_1986}
The known mathematical forms of the electric and magnetic components of this resonant mode together with a super-Gaussian envelope function (\ref{eq:reg_of_influence}) allow the three main effects of a pill-box RF cavity element on the electron pulse to be described within the approximation of the linear force extension to the AG model: the primary action of the pulse compression (or acceleration and expansion dependent upon the relative RF phase), and the transverse lens effects due to the magnetic component of the $\text{TM}_{010}$ resonance and the electric RF cavity fringe fields at its entrance and exit apertures.\cite{kim_rf_1989}

The spatial dependence of the axial RF electric field experienced by the electron pulse in a TM$_{010}$ cavity of radius $a$ may be written as
\begin{equation} \label{eq:RF_Efield}
  E ( r , z , z^{\prime} ) = E_{0} \sin \left ( \frac{ \Omega ( z^{\prime} - z ) }{ v_{{ \scriptscriptstyle 0}} } + \phi \right )\operatorname{J_{0}} \left ( \frac{ k r }{ a } \right ) \text{,}
\end{equation}
where $ E_{ 0 } $ is the oscillating field amplitude, $\Omega$ is the RF frequency and $\phi$ is a phase factor determining whether the RF cavity acts as a pulse compressor $ ( \phi \approx 0 ) $ or an electron accelerator $ ( \phi \approx \pm \pi/2 ) $.
The coordinate $z^{\prime} $ describes the position of the center of the pulse in the RF cavity, which extends from $ z^{\prime} = - d / 2 $ to $ z^{\prime} = d / 2 $, and $z$ is the position of any electron in the pulse with respect to the center of the pulse.
For the $\text{TM}_{010}$ oscillation mode, the RF frequency is given by
\begin{equation}
  \Omega = \frac{ c k }{a} \text{,}
\end{equation}
where $c$ is the speed of light in a vacuum and $ k = 2.405 $ is the first zero of the $\operatorname{ J_{0} }$ Bessel function.

For the usual case of a spatially compact electron pulse with respect to the dimension of the RF cavity (i.e., $ \Omega z \ll v_{{ \scriptscriptstyle 0}} $ and $ \sqrt{\sigma_{\smallT}} \ll a $), \ref{eq:RF_Efield} can be rewritten as
\begin{equation} \label{eq:RF_Efield_approx}
  E ( r , z , z^{\prime} ) = E_{0} \biggl [ \sin \left ( \frac{ \Omega z^{\prime} }{ v_{{ \scriptscriptstyle 0}} } + \phi \right ) - \frac{ \Omega z }{ v_{{ \scriptscriptstyle 0}} } \cos \left ( \frac{ \Omega z^{\prime} }{ v_{{ \scriptscriptstyle 0}} } + \phi \right ) \biggr ] \text{,}
\end{equation}
which demonstrates that the RF cavity acts both as a pulse acceleration (first term on RHS of \ref{eq:RF_Efield_approx}) and a pulse compression or expansion (second term on RHS of \eqref{eq:RF_Efield_approx}) device.
The second term then gives the desired form (see \ref{eq:linear_force}) for the force manipulating the temporal dynamics and characteristics during electron pulse compression;
\begin{equation} \label{eq:RF_Force_z}
  \boldsymbol{F}_{ z , RF } = - \left [ \frac{ e \Omega E_{0} }{ v_{{ \scriptscriptstyle 0}} } \cos \left ( \frac{ \Omega z^{\prime} }{ v_{{ \scriptscriptstyle 0}} } + \phi \right ) \right ] z \hat{\operatorname{ \boldsymbol{z} }} \text{.}
\end{equation}

By considering the impulse exerted by the RF cavity field on the electrons in the pulse, it is straightforward to show that pulse compression (when $\phi = 0$) is maximized for $ \Omega d / (2 v_{{ \scriptscriptstyle 0}} ) = \pi /2 $; that is, the time of flight of the electron pulse through the RF cavity of length $ d $ is equal to half the RF period.
Such a calculation assumes that the pulse velocity $v_{{ \scriptscriptstyle 0}}$ is constant; so that, the condition that $ \phi = 0 $ when the pulse is at the center of the RF cavity (i.e., when the pulse is at $ z^{\prime} = 0 $) is readily met.
As suggested by the acceleration term in \ref{eq:RF_Efield_approx}, this is only a good approximation if the RF field amplitude $E_{0}$ is sufficiently small to not affect the velocity of the peak of the pulse as it propagates through the cavity.
As a result, in practice, the phase $\phi$ of the RF field is adjusted to optimize the performance of the cavity.

The two main effects contributing to the transverse lens of a $\text{TM}_{010}$-mode RF cavity, its magnetic field component and electric fringe field aperture effects, may also be included within the linear force approximation.
The azimuthal magnetic component of the resonant mode oscillates 90$^{\circ}$ out of phase with the electric component and with a $\operatorname{ J_{1} }$ Bessel radial form; i.e., $ \operatorname{ J_{1} }( k r / a ) \sim k r / a $ for small $r$.
Symmetry and Gauss' Law dictate that in the vicinity of the axial center of the entrance and exit apertures of the RF cavity there exists a radial component of the oscillating electric field determined by $ E_{r} = -\left ( r / 2 \right ) \left ( \partial E_{z} / \partial z \right )_{r=0} $,\cite{kim_rf_1989} where the form of the axial electric field for $\text{TM}_{010}$ oscillation (\ref{eq:RF_Efield}) implies that, in the context of this analysis, its axial gradient is solely dependent upon the envelope function for the RF cavity (\ref{eq:reg_of_influence}).
In practice, of course, the exact form of $E_{r}(z)$ is strongly tied to the size and shape of the RF cavity apertures, as illustrated by $1 \frac{1}{2}$-cell RF photo-gun designs.\cite{mcdonald_design_1988}
For the case of an evacuated cavity, these two contributions result in a net force,
\begin{equation} \label{eq:RF_Force_r}
  \boldsymbol{F}_{ r , RF } = e E_{0} \left [ 
    \frac{ v_{{ \scriptscriptstyle 0}} \Omega }{c^{2}} \cos \left ( \frac{ \Omega z^{\prime} }{ v_{{ \scriptscriptstyle 0}} } + \phi \right ) + \frac{2 n}{d} \left ( \frac{z^{\prime} - z^{\prime}_{RF}}{d / 2} \right )^{2 n - 1} \sin \left ( \frac{ \Omega z^{\prime} }{ v_{{ \scriptscriptstyle 0}} } + \phi \right )
   \right ] r \hat{\operatorname{ \boldsymbol{r} }} \text{.}
\end{equation}
In obtaining \ref{eq:RF_Force_r}, which is also of the form for use in \ref{eq:linear_force}, we have again used an arbitrary super-Gaussian of order $n$ as a region of influence envelope (see \ref{eq:reg_of_influence}) with $L_{RF} \equiv d$, the RF cavity length.
For the examples shown below under the pulse compression conditions ($\phi = 0$ when the pulse is at $z^{\prime} = 0$), both effects are defocusing for the electron pulse and the magnetic contribution is smaller than the transverse lenses associated with the RF cavity apertures when $ d = \pi v_{{\scriptscriptstyle 0}} / \Omega $,\cite{kim_rf_1989} even though its magnitude is maximized for $\phi = 0$.
Other effects, such as magnetic fringe field aperture effects, could also be included, but are significantly weaker.

% excluded example section from JAP paper as it will need new graphics
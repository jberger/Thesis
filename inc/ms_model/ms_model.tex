%This work is licensed under the Creative Commons Attribution-NonCommercial-NoDerivs 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-nd/3.0/us/ or send a letter to Creative Commons, 444 Castro Street, Suite 900, Mountain View, California, 94041, USA.

\section{Model of Michalik and Sipe}

This section introduces the Analytic Gaussian model of Michalik and Sipe \cite{michalik_analytic_2006}.

\subsection{Formal Evolution} \label{sec:formal_evolution}

Before one may describe the evolution of a pulse of electrons, one must first learn to describe the pulse.
Rather than record the position of each electron, commonly one writes a distribution function for the electrons.
A distribution function describes the location of a number of objects in a certain space.
This space may be a 1D line, a 3D space, or even a 6D phase space (three spatial dimensions and three momentum dimensions).
The functional form may be chosen to appropriately characterize the objects in a natural way, however one property is true for all distribution functions: when integrated over all relevant space, all objects should be accounted for.
In $n$ dimensional space, with $N$ objects, this normalization condition on a distribution function $f$ can be written mathematically as
\begin{equation}
N = \int\limits_{\text{all space}} \!\!\! f(\vec{x}) \; d^{n}x
\end{equation}
which for 6D phase space is written as
\begin{equation} \label{eq:normalization}
N = \int f (\vec{r}, \vec{p}; t) \; d^{3}x\,d^{3}p
\end{equation}
This notation suggests to the reader that the distribution function is implicitly a function of time as well as of the spatial and momentum dimensions.

For a classical set of $N$ particles (labelled by the index $i$), distributed in 6D space (3 position, 3 momentum) by 
\begin{equation}
  f_{\smallD}(\vec{r}, \vec{p}; t) = 
  \sum\limits^{N}_{i=1} \delta(\vec{r}_{i} - \vec{r}) \delta(\vec{p}_{i} - \vec{p})
\end{equation}
which automatically satisfies \ref{eq:normalization}.
The particles have mass $m$ which interact with some potential $V(\vec{r}_{i} - \vec{r}_{j})$, their motion is governed by the equations
\begin{subequations}\label{eq:std_motion}
\begin{gather}
  \frac{d\vec{r}_{i}(t)}{dt} = \frac{\vec{p}_{i}(t)}{m}\\
  \frac{d\vec{p}_{i}(t)}{dt} = -\sum\limits_{j} \frac{d}{d\vec{r}_{i}} V(\vec{r}_{i} - \vec{r}_{j})
\end{gather}
\end{subequations}
Now consider the time evolution of $f_{\smallD}$
\begin{equation}
  \frac{\partial f_{\smallD}}{\partial t} = 
  \frac{d\vec{r}}{dt} \frac{\partial f_{\smallD}}{\partial \vec{r}} 
  + \frac{\partial f_{\smallD}}{\partial \vec{p}} \frac{d\vec{p}}{dt}
\end{equation}
but with \ref{eq:std_motion} the final discreet evolution equation is
\begin{equation}
  \frac{d}{dt} f_{\smallD}(\vec{r}, \vec{p}; t) =
  -\frac{\vec{p}}{m} \frac{\partial}{\partial \vec{r}} f_{\smallD}(\vec{r}, \vec{p}; t)
  + \frac{\partial}{\partial \vec{p}} f_{\smallD} (\vec{r}, \vec{p}; t)
  \frac{\partial}{\partial \vec{r}} \iint d\vecprime{r} d\vecprime{p} V(\vec{r} - \vecprime{r}) f_{\smallD}(\vecprime{r},\vecprime{p};t)
\end{equation}
where the extra minus sign comes from the change of perspective of \ref{eq:std_motion} from the frame of the individual particle $i$ to the observer frame.
%TODO ensemble av and mean-field
Final equation:
\begin{equation} \label{eq:formal_evolution}
  \frac{d}{dt} f(\vec{r}, \vec{p}; t) =
  -\frac{\vec{p}}{m} \frac{\partial}{\partial \vec{r}} f(\vec{r}, \vec{p}; t)
  + \frac{\partial}{\partial \vec{p}} f (\vec{r}, \vec{p}; t)
  \frac{\partial}{\partial \vec{r}} \iint d\vecprime{r} d\vecprime{p} V(\vec{r} - \vecprime{r}) f(\vecprime{r},\vecprime{p};t)
\end{equation}

\subsection{Evolution of a Gaussian Distribution}

The formal evolution explored in \ref{sec:formal_evolution} allows for any distribution function.
For Ultrafast Electron Microscopy, the electron pulse is generated by a laser pulse, therefore the electron pulse can be thought to be a Gaussian, mimicing the laser pulse which generated it.
How correct this assumption is will be explored in \ref{sec:initial_conditions}.
In this section we consider a Gaussian distribution function, generally of the form
\begin{equation}
  f(\vec{r}, \vec{p}; t) = C(t)\exp \left[ - \Gamma(\vec{r}, \vec{p}; t) \right]
\end{equation}
The analysis presented here will consider a cylindrically symmetric pulse.
For the remainder of this analysis, the subscripts $\smallT$ (transverse) and $z$ (longitudinal) will accompany many quantites, reflecting the congruence of $x$ and $y$.
The subscript $\alpha$ will refer to either $\smallT$ or $z$.
In this case we choose the argument (i.e. the function $\Gamma$) as
\begin{equation} \label{eq:gaussian_exponent}
  \Gamma(\vec{r}, \vec{p}; t) =
  \frac{x^2 + y^2}{2 \sigma_{\smallT}} + \frac{z^2}{2 \sigma_{z}}
  + \frac{
    [p_x - (\gamma_{\smallT}/\sigma_{\smallT}) x ]^2 
    + [p_y - (\gamma_{\smallT}/\sigma_{\smallT}) y ]^2
  }{2 \eta_{\smallT}}
  + \frac{ [p_z - (\gamma_{z}/\sigma_{z}) z ]^2 }{2 \eta_{z}}
\end{equation}
This parameterization defines the spatial uncertainty $\sigma_{\alpha}$, the local momentum uncertainty $\eta_{\alpha}$, and the momentum chirp $\gamma_{\alpha}$ in each spatial direction.
The ``chirp'' of a pulse quantifies the difference in local momentum from one side of the pulse to the other.
For example, in a pulse which is normally (positively) chirped longitudinally, electrons near the front of the pulse will be moving faster (on average) than those in the back.

The normalization constant $C(t)$, for $N$ total particles, is found by applying equation \ref{eq:normalization}
\begin{equation}
  C(t) = \frac{N}{(2\pi)^3} 
  \left( 
    \frac{1}{\sigma_{\smallT}^2\eta_{\smallT}^2\sigma_{z}\eta_{z}}
  \right)^{\frac{1}{2}}
\end{equation}
These equations may be viewed from a matrix perspective if we define the ``coordinate vector''
\begin{equation} \label{eq:coordinate_vector}
u_i = \{x, p_x, y, p_y, z, p_z\}\text{ .}
\end{equation}
In this space, \ref{eq:gaussian_exponent} becomes
\begin{equation}
  \Gamma(\vec{r}, \vec{p}; t) = \frac{1}{2}\sum\limits_{ij} A_{ij} u_i u_j
\end{equation}
where
\begin{equation}
  A = 
  \begin{pmatrix}
    a_{\smallT} & 0 & 0 \\
    0 & a_{\smallT} & 0 \\
    0 & 0 & a_{z}
  \end{pmatrix}
  \qquad \text{and} \qquad
  a_{\alpha} = 
  \begin{pmatrix}
    1/\sigma_{\alpha} + \gamma_{\alpha}^2/(\eta_{\alpha} \sigma_{\alpha}) & \gamma_{\alpha}/(\eta_{\alpha} \sigma_{\alpha}) \\
    \gamma_{\alpha}/(\eta_{\alpha} \sigma_{\alpha}) & 1/\eta_{\alpha}
  \end{pmatrix}
\end{equation}
with ${\scriptstyle \alpha} = \smallT \text{ or } z$. 
A nice property of Gaussians of this form is the convenient ``Multidimensional Gaussian Integral'' given by
\begin{equation} \label{eq:gaussian_integral}
  (A^{-1})_{ij} = \frac{1}{N} \int u_i u_j f(\vec{r}, \vec{p}; t) d\vec{r} d\vec{p}
\end{equation}
which is a common form of integral analysis in Quantum Field Theory (see for example Peskin and Schroeder Equation 9.70). 
Application of this integral yields
\begin{equation}
  A = 
  \begin{pmatrix}
    a_{\smallT}^{-1} & 0 & 0 \\
    0 & a_{\smallT}^{-1} & 0 \\
    0 & 0 & a_{z}^{-1}
  \end{pmatrix}
  \qquad \text{and} \qquad
  a^{-1}_{\alpha} = 
  \begin{pmatrix}
    \sigma_{\alpha} & \gamma_{\alpha} \\
    \gamma_{\alpha} & \eta_{\alpha} + \gamma_{\alpha}^2/\sigma_{\alpha}
  \end{pmatrix}
\end{equation}

Since time derivative of \ref{eq:gaussian_integral} is simply
\begin{equation} \label{eq:gaussian_integral_dt}
  \frac{d}{dt}(A^{-1})_{ij} = \frac{1}{N} \int u_i u_j \frac{df(\vec{r}, \vec{p}; t)}{dt} d\vec{r} d\vec{p}
\end{equation}
and the time derivative of the components of $A^{-1}$ are
\begin{equation} \label{eq:dainvdt}
  \frac{d}{dt} a^{-1}_{\alpha} = 
  \begin{pmatrix}
    \dfrac{d\sigma_{\alpha}}{dt} & \dfrac{d\gamma_{\alpha}}{dt} \\
    \dfrac{d\gamma_{\alpha}}{dt} & \dfrac{d\eta_{\alpha}}{dt} + 2\dfrac{\gamma_{\alpha}}{\sigma_{\alpha}}\dfrac{d\gamma_{\alpha}}{dt}- \dfrac{\gamma^{2}_{\alpha}}{\sigma^{2}_{\alpha}}\dfrac{d\sigma_{\alpha}}{dt}
  \end{pmatrix}
\end{equation}
these components, when viewed in the context of \ref{eq:formal_evolution}, form the left hand side (LHS) of the system of differential equations governing the evolution of $\sigma_{\alpha}$, $\gamma_{\alpha}$, and $\eta_{\alpha}$, which will be established in the upcoming sections.

\subsection{Generating the Differential Equations}

Inserting \ref{eq:formal_evolution} into \ref{eq:gaussian_integral_dt} yields two integral terms, one related to the propagation of a non-charged Gaussian beam, the other adds the influence of the internal force due to Coulomb repulsion.
These terms will be denoted $K^{flow}$ and $K^{force}$ respectively.
\begin{equation} \label{eq:gaussian_integral_dt_k}
  \frac{d}{dt}(A^{-1})_{ij} = K^{flow}_{ij} + K^{int}_{ij}
\end{equation}
Collecting and expanding terms where possible gives these forms of the $K$ terms
\begin{gather}
  K^{flow}_{ij} \equiv -\frac{1}{N} \int u_i u_j \frac{\vec{p}}{m} \frac{\partial f}{\partial \vec{r}} d\vec{r} d\vec{p} \\
  \label{eq:Kforce}
  K^{force}_{ij} \equiv \frac{1}{N} \int u_i u_j \frac{\partial f}{\partial \vec{p}} \frac{\partial \Phi(\vec{r};t)}{\partial \vec{r}} d\vec{r} d\vec{p} \\
  n(\vec{r};t) \equiv \int d\vec{p} f(\vec{r},\vec{p};t) 
    = \frac{N}{(2\pi)^{3/2} \sigma_{\smallT} \sqrt{\sigma_{z}}} \exp \left( -\frac{x^2+y^2}{2\sigma_{T}} - \frac{z^2}{2\sigma_{z}} \right) \\
    \label{eq:potential_integral}
    \Phi(\vec{r};t) \equiv \int d\vecprime{r} V(\vec{r} - \vecprime{r}) n(\vecprime{r}; t)
\end{gather}
Obviously the $K^{flow}$ term is far easier to evaluate
\begin{equation}
  K^{flow} = 
  \begin{pmatrix}
    k^{flow}_{\smallT} & 0 & 0 \\
    0 & k^{flow}_{\smallT} & 0 \\
    0 & 0 & k^{flow}_{z}
  \end{pmatrix}
  \quad \text{and} \quad
  k^{flow}_{\alpha} = 
  \begin{pmatrix}
    \dfrac{2\sigma_{\alpha}}{m} & \dfrac{1}{m} \left(\eta_{\alpha} + \dfrac{\gamma_{\alpha}^2}{\sigma_{\alpha}} \right) \\
    \dfrac{1}{m} \left(\eta_{\alpha} + \dfrac{\gamma_{\alpha}^2}{\sigma_{\alpha}} \right) & 0
  \end{pmatrix}
\end{equation}

The $K^{force}$ integrals, related to the internal force of the pulse's Coulombic repulsion, are far more complicated to evaluate.
For more information about the derivation, see \cite{michalik_analytic_2006}.
The final matrices are
\begin{equation}
  K^{force} = 
  \begin{pmatrix}
    k^{force}_{\smallT} & 0 & 0 \\
    0 & k^{force}_{\smallT} & 0 \\
    0 & 0 & k^{force}_{z}
  \end{pmatrix}
\end{equation}
where
\begin{equation}
  k^{force}_{\alpha} = 
  \frac{N e^2}{4\pi\varepsilon_0} \frac{1}{2\pi^{1/2}\sigma_{\alpha}^{1/2}} L_{\alpha}(\xi)
  \begin{pmatrix}
    0 & 1 \\
    1 & \dfrac{2 \gamma_{\alpha}}{\sigma_{\alpha}}
  \end{pmatrix}
\end{equation}
The parameter $\xi$ is the ellipticity parameter, defined as
\begin{equation}
  \xi \equiv \sqrt{\dfrac{\sigma_{z}}{\sigma_{\smallT}}}
\end{equation}
Note that the original paper of Michalik and Sipe contained an error which incorrectly defined $\xi$; this was corrected in an erratum \cite{michalik_erratum:_2008}.
The family of $L$ functions are
\begin{gather}
  L_{\smallT}(\xi) = \frac{3}{2} \left( L(\xi) + \frac{\xi^2 L(\xi) - \xi}{ 1 - \xi^2 } \right) \\
  L_{z}(\xi) = \frac{ 3 \xi^2 }{ \xi^2 - 1} \left( \xi L(\xi) - 1 \right) \\
  L(\xi) = \frac{1}{2} \int_0^{\pi} \frac{1}{1+\xi\sin(\theta)} d\theta
\end{gather}
The integral function $L(\xi)$ can be evaluated to the piecewise function
\begin{equation}
  L(\xi) = 
  \begin{cases}
    \frac{ \arcsin \sqrt{1-\xi^2} }{ \sqrt{1-\xi^2} } & 0 \le \xi \le 1 \\
    \frac{ \ln\left( \xi + \sqrt{\xi^2 - 1} \right) }{ \sqrt{\xi^2 - 1} } & \xi \ge 1
  \end{cases}
\end{equation}
which, although piecewise, is a smooth and well behaved function.

\subsection{The Differential Equation System}

When these $K$ matrices are summed (\ref{eq:gaussian_integral_dt_k}) to form the right hand side (RHS) of the differential equations and compared to LHS derived above (\ref{eq:dainvdt}), the non-zero elements finally yield a system of differential equations which govern the dynamics of these Gaussian beam parameters.

\begin{subequations} \label{eq:ag_original}
\begin{gather}
  \frac{d\sigma_{\alpha}}{dt} = \frac{2\gamma_{\alpha}}{m} \\
  \frac{d\gamma_{\alpha}}{dt} = \frac{1}{m} \left(\eta_{\alpha} + \frac{\gamma_{\alpha}^2}{\sigma_{\alpha}} \right) 
    + \frac{N e^2}{4\pi\varepsilon_0} \frac{1}{6 \sqrt{\sigma_{\alpha}\pi}} L_{\alpha}(\xi)\\
  \frac{d\eta_{\alpha}}{dt} = - \frac{2 \gamma_{\alpha} \eta_{\alpha}}{m \sigma_{\alpha}}
\end{gather}
\end{subequations}
